<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html"; charset="UTF8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="../common/delimited-favicon-v4.ico">
    <style>
      #tooltip {
        color: white;
        opacity: .9;
        background: #333;
        padding: 5px;
        border: 1px solid lightgrey;
        border-radius: 5px;
        position: absolute;
        z-index: 10;
        visibility: hidden;
        white-space: nowrap;
        pointer-events: none;
      }
      #circle circle {
        fill: none;
        pointer-events: all;
      }
      path.group {
        fill-opacity: .8;
      }
      path.chord {
       
        fill-opacity: .8;
        stroke: #000;
        stroke-width: .5px;
       
      }
      #circle:hover path.fade {
        display: none;
      }
    </style>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-45101494-1']);
    _gaq.push(['_setDomainName', 'delimited.io']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
  </head>
  <body>
    <div id="launch" ><button onclick="drawdiagram(filterval='',colA='groupfrom',colB='groupto',val='groupcount');setclickdraw()">Draw!</button>
    <button onclick="drawdiagram(filterval='',colA='from',colB='to',val='count');setclickdrawoverall()">Draw Overall!</button></div>
    <div id="help" >Click on a segment[on the perimeter] to expand it!</div>
    <div id="tooltip"></div>
    <script src="lib/d3.min.js"></script>
    <script src="lib/underscore.js"></script>
    <script src="lib/mapper.js"></script>
        <script src="lib/palette.js"></script>
 
    <script>
      //*******************************************************************
      //  CREATE MATRIX AND MAP
      //*******************************************************************
function finaldata(exmatrix,exmap){
//var exmap={"Assistant Manager":{"name":"Assistant Manager","id":0},"Associate":{"name":"Associate","id":1},"Developer/Analyst":{"name":"Developer/Analyst","id":2},"Director":{"name":"Director","id":3},"Junior Developer/Junior Analyst":{"name":"Junior Developer/Junior Analyst","id":4},"Manager":{"name":"Manager","id":5},"Senior Developer/Senior Analyst":{"name":"Senior Developer/Senior Analyst","id":6},"Senior Director":{"name":"Senior Director","id":7},"Senior Manager":{"name":"Senior Manager","id":8},"Learning":{"name":"Learning","id":9}};
//var exmatrix=[[0,0,0,0,0,0,0,0,0,805],[0,0,0,0,0,0,0,0,0,25510],[0,0,0,0,0,0,0,0,0,774],[0,0,0,0,0,0,0,0,0,96],[0,0,0,0,0,0,0,0,0,29],[0,0,0,0,0,0,0,0,0,799],[0,0,0,0,0,0,0,0,0,1215],[0,0,0,0,0,0,0,0,0,16],[0,0,0,0,0,0,0,0,0,21],[805,25510,774,96,29,799,1215,16,21,0]];
var data2,aggdataset=[];
var storekey,temp,index=0,index2=0;
var cond= 'AIG 6th floor';
var subgroups=[];
for(key in exmap){
  if(exmap[key].name=="Learning") break;
    index+=1;
  }
//console.log(index);   
for(key in exmap){
  if(exmap[key].id==exmatrix.length-1 &&  ('Learning' in exmap)){
    

    storekey=exmap[key].id;
    exmap[key].id=index;
    exmap['Learning'].id=exmatrix.length-1;
    //console.log(storekey);  
    
  }
}
if('Learning' in exmap){
subgroups=exmatrix[storekey];
exmatrix[storekey]=exmatrix[index];
exmatrix[index]=subgroups;

for(var i=0;i<exmatrix.length;i++){
  temp=exmatrix[i][index];
  exmatrix[i][index]=exmatrix[i][storekey];
  exmatrix[i][storekey]=temp;
}
}
for(key in exmap){
  if(exmap[key].name=="Roles") 
    index2=exmap[key].id;
  } 

for(key in exmap){
  
  if(exmap[key].id==0 &&  ('Roles' in exmap)){
    storekey=exmap[key].id;
    exmap[key].id=index2;
    exmap['Roles'].id=0;
    //console.log(storekey);  

    }
  
}
if('Roles' in exmap){
subgroups=exmatrix[storekey];
exmatrix[storekey]=exmatrix[index2];
exmatrix[index2]=subgroups; 
for(var i=0;i<exmatrix.length;i++){
  temp=exmatrix[i][index2];
  exmatrix[i][index2]=exmatrix[i][storekey];
  exmatrix[i][storekey]=temp;
}
}
return [exmatrix,exmap];
}    
function changedata(condition){
var dummy=[];
var dummy2=[];
var dummy3=[];
var index=0;
var flag;
var cond=condition;
d3.csv("data/lnduse3.csv",function(error,data){
data.count=+data.count;
dummy=data;
for(var i=0;i<dummy.length;i++)
  {
    if(dummy[i].fromregion==cond || dummy[i].toregion==cond) {
        dummy2[i]={};
        if(dummy[i].fromregion==cond) dummy2[i]['from']=dummy[i].from;
        else dummy2[i]['from']=dummy[i].fromregion
 
        if(dummy[i].toregion==cond) dummy2[i]['to']=dummy[i].to;
        else dummy2[i]['to']=dummy[i].toregion
        dummy2[i]['count']=dummy[i].count;
      }
 
    else {
 
        dummy2[i]={};
        dummy2[i]['from']=dummy[i].fromregion;
        dummy2[i]['to']=dummy[i].toregion;
        dummy2[i]['count']=dummy[i].count;
 
      }
  }
 
 
dummy2.count=+dummy2.count;
//console.log("outside");
for(var k=0;k<dummy2.length;k++)
{
  if(k==0){
  dummy3[index]={}
  dummy3[index]['from']=dummy2[k]['from'];
  dummy3[index]['to']=dummy2[k]['to'];
  dummy3[index]['count']=dummy2[k]['count'];
  index+=1;
  }
  else{
    flag=0;
  for(var l=0;l<dummy3.length;l++){
   
    if (dummy2[k].from==dummy3[l].from && dummy2[k].to==dummy3[l].to){
     // console.log(dummy3[l].count);
      //console.log(index);
      dummy3[l].count=+dummy3[l].count;
      dummy2[k].count=+dummy2[k].count;
      dummy3[l].count=dummy2[k].count+dummy3[l].count;
      flag=1;
      //console.log(dummy3[l].count);
    }
  }
    if(flag==0){
      //console.log(dummy3.length);
      //console.log(k);
      dummy3[index]={};
      dummy3[index]['from']=dummy2[k]['from'];
      dummy3[index]['to']=dummy2[k]['to'];
      dummy3[index]['count']=dummy2[k]['count'];
      index+=1;
    }
 
  }
}
 
});
return dummy3;
}
function setclickdraw(){
  click=0;
  deepest=false;
}
function setclickdrawoverall()
{
  click=1;
  deepest=true;
}
 
function regionfilter(x,dataset){
  var result=[];
  var fill=[];
for(var m=0;m<dataset.length;m++)
{
  if(dataset[m].fromregion==x)
  {
   result.push(dataset[m]);
  }
}
return result;
}
      var dataset;
      var deepest;
      var map;
      var click;
    function drawdiagram(filterval,colA,colB,val,input) {
      d3.selectAll("svg").transition().duration(300).style("opacity",0).each("end",function(d){d3.select(this).remove()});
     //d3.selectAll("svg").remove();
     //console.log(filterval);
      filterval = filterval || "empty";
      colA=colA || "from";
      colB=colB || "to";
      val=val ||"count";
      if(typeof input==="undefined"){input = 'default'};
 
      if(click==1){
        deepest=true;
      }
 
      else{deepest=false;}
    
      d3.csv('data/lnduse3.csv', function (error, data) {
       dataset=data;
        if(filterval!='empty'){
 
        data=regionfilter(filterval,data);      
        }
        if(input=='default'){
          var mpr = chordMpr(data);
        }
        else {
          for(key in input){
            input[key].count=+input[key].count;
          }
         
          //console.log(input);
          var mpr=chordMpr(input);}
        
        //console.log(data);
        mpr
          .addValuesToMap(colA)
         
          .setFilter(function (row, a, b) {
            //console.log(row[colA]);
            return (row[colA] === a.name && row[colB] === b.name)
          })
          .setAccessor(function (recs, a, b) {
            if (!recs[0]) return 0;
            return +recs[0][val];
          });
        map=mpr.getMap(); 
        console.log(JSON.stringify(mpr.getMap()));
        console.log(JSON.stringify(mpr.getMatrix()));
        //console.log(JSON.stringify(finaldata(mpr.getMatrix(), mpr.getMap())[0]));
       // console.log(JSON.stringify(finaldata(mpr.getMatrix(), mpr.getMap())[1]));
        //drawChords(mpr.getMatrix(),mpr.getMap());
        drawChords(finaldata(mpr.getMatrix(),mpr.getMap())[0],finaldata(mpr.getMatrix(),mpr.getMap())[1]);
      });
    }
      //*******************************************************************
      //  DRAW THE CHORD DIAGRAM
      //*******************************************************************
      function drawChords (matrix, mmap) {
        var w = 980, h = 900, r1 = h / 2, r0 = r1 - 100;
        var colarr=palette(['sol-accent'],8)
        var colarr2=[];
        for(var q=0;q<colarr.length;q++)
        {
          colarr2[q]='#'+colarr[q];
        }
        var colarr3=["#00a4e4","#005984"];
            if(!deepest){
             fill = d3.scale.ordinal()
            .domain(d3.range(28))
            .range(colarr3);}
            else{
            fill = d3.scale.ordinal()
                        .domain(d3.range(28))
                        .range(colarr2);}
       
        var chord = d3.layout.chord()
            .padding(.02)
            //.sortSubgroups(d3.descending)
            //.sortChords(d3.descending);
 
        var arc = d3.svg.arc()
            .innerRadius(r0)
            .outerRadius(r0 + 20);
 
        var svg = d3.select("body").append("svg:svg")
            .attr("width", w)
            .attr("height", h)
          .append("svg:g")
            .attr("id", "circle")
            .attr("transform", "translate(" + w / 2 + "," + h / 2 + ")");
 
            svg.append("circle")
                .attr("r", 100 );
 
        var rdr = chordRdr(matrix, mmap);
        chord.matrix(matrix);
 
        var g = svg.selectAll("g.group")
            .data(chord.groups())
          .enter().append("svg:g")
            .attr("class", "group")
            .on("mouseover", mouseover)
            .on("mouseout", function (d) { d3.select("#tooltip").style("visibility", "hidden") })
            .on("click",
              function(d){
                //console.log(deepest);
                //console.log(click);
                if(!deepest){
                  click=1;
                  d3.select(this).transition().duration(500).style("opacity",0);
                drawdiagram(filterval='',colA='from',colB='to',val='count',input=changedata(rdr(d).gname))}
                else{
                	if(rdr(d).gname=="Roles"||rdr(d).gname=="Learning"){
                		setclickdrawoverall();
                		drawdiagram(filterval='',colA='from',colB='to',val='count');
                	}
                }
              });
 
        g.append("svg:path")
            .style("stroke", "black")
            .style("fill", function(d) { if(rdr(d).gname=='Roles') return "#00a4e4"; else if(rdr(d).gname=='Learning') return "#005984"; else return fill(d.index); })
            .attr("d", arc);
 
        g.append("svg:text")
            .each(function(d) { d.angle = (d.startAngle + d.endAngle) / 2; })
            .attr("dy", ".35em")
            .style("font-family", "helvetica, arial, sans-serif")
            .style("font-size", "14px")
            .attr("text-anchor", function(d) { return d.angle > Math.PI ? "end" : null; })
            .attr("transform", function(d) {
              return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")"
                  + "translate(" + (r0 + 26) + ")"
                  + (d.angle > Math.PI ? "rotate(180)" : "");
            })
            .text(function(d) { return rdr(d).gname; })
            /*.on("click",
              function(d){
                if(!deepest){
                drawdiagram(filterval=rdr(d).gname,colA='from',colB='to',val='count',input='')}
              })*/;
 
          var chordPaths = svg.selectAll("path.chord")
                .data(chord.chords())
              .enter().append("svg:path")
                .attr("class", "chord")
                .style("stroke", function(d) {return  "black"})//return d3.rgb(fill(d.target.index)).darker(); })
                .style("fill", function(d) { return fill(d.target.index); })
                .attr("d", d3.svg.chord().radius(r0))
                .on("mouseover", function (d) {
                  d3.select("#tooltip")
                    .style("visibility", "visible")
                    .html(chordTip(rdr(d)))
                    .style("top", function () { return (d3.event.pageY - 100)+"px"})
                    .style("left", function () { return (d3.event.pageX - 100)+"px";})
                })
                .on("mouseout", function (d) { d3.select("#tooltip").style("visibility", "hidden") })
                ;
 
          function chordTip (d) {
            var p = d3.format(".2%"), q = d3.format(",.3r")
            return "Chord Info:<br/>"
              +  q(d.svalue) + " hours spent by "
              + d.sname + " on " + d.tname
              //+ (d.sname === d.tname ? "": ("<br/>WHEREAS<br/>"
              //+ p(d.tvalue/d.ttotal) + " (" + q(d.tvalue) + ") of "
              //+ d.tname + " moves " + d.sname))
          }
 
          function groupTip (d) {
            var p = d3.format(".1%"), q = d3.format(",.3r")
            return "Group Info:<br/>"
                + d.gname + " : " + q(d.gvalue) + " Hours";
                
          }
 
          function mouseover(d, i) {
            d3.select("#tooltip")
              .style("visibility", "visible")
              .html(groupTip(rdr(d)))
              .style("top", function () { return (d3.event.pageY - 80)+"px"})
              .style("left", function () { return (d3.event.pageX - 130)+"px";})
 
            chordPaths.classed("fade", function(p) {
              return p.source.index != i
                  && p.target.index != i;
            });
          }
           
 
      }
     
    </script>
  </body>
</html>